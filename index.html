<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP32 GPS Map Sender</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script
 src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; }
#map { height:75vh; }
button {
  width:100%;
  font-size:40px;
  padding:30px;
  border:none;
  background:#007bff;
  color:white;
}
#status {
  text-align:center;
  font-size:28px;
  padding:10px;
}
</style>
</head>
<body>

<div id="map"></div>
<button onclick="getLocation()">現在位置取得＆送信</button>
<div id="status">待機中</div>
<button onclick="testSend()">送信テスト</button>
<script>

let map = L.map('map', { maxZoom:20 }).setView([35,139], 5);
let marker = null;

// OpenStreetMapタイル
L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{ attribution:'© OpenStreetMap' }
).addTo(map);

// サイズずれ対策
setTimeout(() => {
  map.invalidateSize();
}, 300);

 function testSend(){
  fetch("/location?lat=1&lon=2")
    .then(res => res.text())
    .then(txt => alert("送信OK"))
    .catch(err => alert("送信失敗"));
}
 
function getLocation(){

  document.getElementById("status").innerHTML = "取得中...";

  if(!navigator.geolocation){
    document.getElementById("status").innerHTML = "GPS未対応";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function(pos){

      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;

      // ズーム移動
      map.flyTo([lat,lon], 19);

      setTimeout(() => {
        if(marker){
          marker.setLatLng([lat,lon]);
        } else {
          marker = L.marker([lat,lon]).addTo(map);
        }
      }, 300);

      // ★ IPを書かずに現在サーバーへ送信
      fetch(`/location?lat=${lat}&lon=${lon}`)
        .then(res => res.text())
        .then(txt => {
          document.getElementById("status").innerHTML =
            "送信成功<br>" +
            lat.toFixed(6) + " , " + lon.toFixed(6);
        })
        .catch(err => {
          document.getElementById("status").innerHTML =
            "送信失敗";
        });

    },
    function(err){
      document.getElementById("status").innerHTML =
        "位置情報エラー: " + err.message;
    },
    { enableHighAccuracy:true }
  );
}

</script>
</body>
</html>
